\begin{algorithm}
    % \setstretch{0.85}
    \begin{algorithmic}[1]

        \caption{Membership protocol (Active view Optimization)}

        \asdstate
            \State parent \Comment{defined in join}
            \State children \Comment{defined in join} 
            \State siblings  
            \State childrenLatencies : dict<string:dict<string:number>>
        \asdend

        \asdrepeateveryx{config.updatePeriodicity}
            \If{parent != nil}
                \State sLatencies \asdassign set()
                \For{sibling in siblings}
                    \State sLatencies.append(<sibling.IP,sibling.measuredLatency)
                \EndFor
                \State sendMessage(UpdateChildStatus<children, siblingLatencies>, parent)
            \EndIf
            \For{child in chidren}
                \State sendMessage(UpdateParentStatus<self,child.ID, parent, siblings>)
            \EndFor
        \asdend

        \asdupon[receive(UpdateParentStatus<parent,myID, grandParent>, sender)]
            \If{sender == parent.IP}
                \State parent \asdassign parent
                \State self.ID \asdassign parent.ID + myID
                \State grandParent \asdassign grandParent
                \State siblings \asdassign siblings
            \EndIf
        \asdend

        \asdupon[receive(UpdateChildStatus<child, childSiblingLatencies>, sender)]
            \If{children[sender] != nil}
                \State childrenLatencies[sender] \asdassign childSiblingLatencies
            \EndIf
        \asdend

        \asdrepeateveryx{config.updateChildPeriodicity}
            \State childrenLatValues \asdassign set()
            \For{c1 in children}
                \For{<c2, lat> in childrenLatencies[c]}
                    \If{lat - c1.measuredLatency <= d.config.maxLatDowngrade}
                        \State childrenLatValues.add(<c1,c2,lat>)
                    \EndIf
                \EndFor
            \EndFor
            \State kickedNodes, newParents \asdassign set(),set()
            \State potentialChildren \asdassign dict<string,set<Node{>}{>}
            \State sortByLatency(childrenLatValues)
            \State idealGroupSize \asdassign config.MaxGroupSize - config.MinGroupSize
            \For{<c1,c2,lat> in childrenLatValues}
                \If{len(children) - len(kickedNodes) <= idealGroupSize}
                    \State break
                \EndIf
                \If{c1 in kickedNodes or c2 in kickedNodes}
                    \State continue
                \EndIf
                \If{loserBWC in newParents}
                    \State continue
                \EndIf
                \If{higherBwNode.nrChildren == 0}
                    \State potentialChildren[higherBwNode].append(c2)
                    \If{len(potentialChildren) >= config.MinGroupSize \&\& len(children) - len(kickedNodes) - len(potentialChildren) < idealGroupSize}
                        \For{potentialChild in potentialChildren[higherBwNode]}
                            \State newParents <- newParents + higherBwNode
                            \State send(OptimizationPropose<higherBwNode>, potentialChild)
                            \State higherBwNode.nrChildren++
                            \State kickedNodes <- kickedNodes + potentialChild
                        \EndFor
                        \For{<nIP,pontentialChildrenTmp> in potentialChildren}
                            \State pontentialChildrenTmp.deleteAll(potentialChildren[higherBwNode])
                        \EndFor
                        \State potentialChildren[higherBwNode] \asdassign set<Node>
                        \State continue
                    \EndIf
                \EndIf
                \State kickedNodes <- kickedNodes + c2
                \State send(OptimizationPropose<higherBwNode>, lowerBWNode)
            \EndFor
        \asdend

        \asdupon[receive(OptimizationPropose<newParent>, sender)]
            \If{sender == parent}
                \State send(OptimizationProposeRequest<sender>, newParent)
            \EndIf
        \asdend

        \asdupon[receive(OptimizationProposeRequest<p>, sender)]
            \If{ p == parent \&\& sender in siblings} \Comment{ parent issuing the message is the same parent that i have}
                \State send(OptimizationProposeRequestReply<true>, sender)
            \Else
                \State sendSideChannel(OptimizationProposeRequestReply<false>, sender)
            \EndIf
        \asdend

        \asdupon[receive(OptimizationProposeRequestReply<reply>, sender)]
            \If{reply}
                \State sendMessageAndDisconnectFrom(DisconnectMessage<>, parent)
                \State addParent(sender)
            \EndIf
        \asdend

    \end{algorithmic}
\end{algorithm}
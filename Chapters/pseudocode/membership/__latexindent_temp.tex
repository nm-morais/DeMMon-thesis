% JOIN -----

\begin{algorithm}
    % \setstretch{0.85}
\begin{algorithmic}[1]
    \caption{Join Protocol (Types and state)} \label{alg:state:join}
    \asdtypes
        \State Node \{
        \Indent
            \State lat \Comment{ the measured latency to the peer}
            \State parentIP \Comment{ the IP of the parent of the Node}
            \State nrChildren \Comment{ the number of children}
            \State replied \Comment{ wether the node replied to joinMessage}
            \State IP \Comment{ the node IP}
            \State children: []<IP, nrChildren> \Comment{ the node's children, can be null for certain nodes (i.e. siblings and node's children), and is not sent in messages }
        \EndIndent
    \asdend
    \asdstate \label{alg:state:state}
        \State contactedNodes \Comment{ collection of all successfully contacted nodes}
        \State nodesToContact \Comment{ nodes being contacted}
        \State joinTimeouts \Comment{ collection of contacted nodes -> timerIDs}
        \State bestPeerLastLevel : Node \Comment{the best peer contacted so far in the join process}
        \State joinTimeoutTimerID \Comment{ timerID for join messages}
        \State self : Node \Comment{ myself}
    \asdend
    
\end{algorithmic}
\end{algorithm}


\begin{algorithm}
    % \setstretch{0.85}
\caption{Membership protocol (Join)}
\begin{algorithmic}[1]


\asdupon[Init(landmarks : map{IP}:Node, selfIP, isLandmark)] \label{alg:memb:join:init}
    \State joinTimeouts \asdassign \{\}
    \State prevBestP \asdassign \{\}
    \State landmarks \asdassign [landmarks]
    \IfThenElse{isLandmark}{addSibling(landmarks)}{contactNodes(landmarks)}
\asdend

\asdprocedure[contactNodes(nodeIPs)]
    \State nodesToContact \asdassign \{\}
    \For{p in nodeIPs}
        \State nodesToContact[p] = Node \{IP: p, replied:false,measured: false\}
        \State MeasureNode(p) 
        \State sendMessageSideChannel(JoinMessage<>, p)
        \State joinTimeouts[p] = \asdassign setupTimer(JoinTimeoutTimer(p))
    \EndFor
\asdend

\asdupon[JoinTimeoutTimer(node) || NodeMeasuringFailed(node)]
        \IfThenElse{(L in Landmarks)}{rejoinLater()}{delete(nodesToContact[L])}
    \asdend

\asdupon[receive(Join<>,sender)]
    \State sendMessageSideChannel(JoinReply<self.parent, self.node, self.children>, sender)
\asdend
    
\asdupon[receive JoinReply(<parentIP, node, children>, sender) \&\& \textbf{measuredLatency}(lat)]
        \If{\asdnotin{parentIP}{contactedNodes}}
            \State nodesToContact.delete(node)
        \Else
            \State nodesToContact[node].lat = lat
            \State nodesToContact[node.IP].children \asdassign children
            \State nodesToContact[node.IP].parent \asdassign parentIP
            \State nodesToContact[node.IP].replied \asdassign true
            \State cancelTimer(joinTimeouts[sender])
            \State delete(joinTimeouts, sender)
        \EndIf
\asdend

\asdupon[(forall n $\in$ nodesToContact -> n.replied)]
    \If{ len(nodesToContact) == 0}
    % \Comment{has not gotten past landmarks}
        \IfThenElse{prevBestP == nil}
        {rejoinLater()}
        {joinAsChild(prevBestP) }
        \State return
    \EndIf
    \State contactedNodes.appendAll(nodesToContact)
    \For{node in sortedByLatency(nodesToContact)}
        \If{prevBestP != nil \&\& prevBestP.lat $\le$ node.lat} 
            \State joinAsChild(prevBestP)
            \State return
        \EndIf
        \If{(\asdnotin{node.IP}{landmarks}) \&\& node.nrChildren == 0}
            \State continue \Comment{check if node has enough children}
        \EndIf
        \State prevBestP = node
        \State toContact \asdassign [c -> c.nrChildren >= config.minGroupSize]
        \State contactNodes(toContact)
        \State return
    \EndFor

    \If{prevBestP.parentIP == nil} \Comment{No nodes were suitable, fallback to parent of best previous node}
        \State prevBestP = contactedNodes[prevBestP.parentIP]
        \State joinAsChild(prevBestP)       
        \State return
    \Else
        \State rejoinLater()
        \State return
    \EndIf
\asdend

\asdprocedure[joinAsChild(p : Node)]
    \State joinTimeoutTimerID = setupTimer(JoinRequestTimeout<p>)
    \State sendMessageSideChannel(JoinRequest<>, p.IP)
\asdend

\asdupon[JoinRequestTimeout(p : Node)]
    \If{p.parentIP != nil}
        \State prevBestP = contactedNodes[prevBestP.parentIP]
        \State joinAsChild(prevBestP)
    \Else
        \State rejoinLater()
    \EndIf
\asdend

\asdupon[receive(JoinRequest<>, sender)]
    \State addChildren(sender) \Comment{new chilren is established}
    \State sendMessageSideChannel(JoinRequestReply<generatedID,self,children>, p.IP)
\asdend
    
\asdupon[receive(JoinRequestReply<attributedId,parent,siblings>, sender)]
    \State addParent(sender) \Comment{Parent is established, join complete}
    \State cancelTimer(joinTimeoutTimerID)
\asdend
\end{algorithmic}
\end{algorithm}
